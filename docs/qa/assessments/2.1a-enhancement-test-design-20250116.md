# Test Design: Story 2.1a Enhancement - Application Database Data Caching

**Date:** 2025-01-16  
**Designer:** Quinn (Test Architect)  
**Enhancement:** Application Database Data Caching and Sync Integration

## Test Strategy Overview

- **Total test scenarios:** 24 (Unit: 12, Integration: 8, E2E: 4)
- **Unit tests:** 12 (50%)
- **Integration tests:** 8 (33%)
- **E2E tests:** 4 (17%)
- **Priority distribution:** P0: 10, P1: 10, P2: 4

## Enhancement Scope

This test plan covers the new application database data caching enhancement that:
- Adds application DB tables to PWA sync service
- Updates admin service to work with local storage first
- Implements background sync for application DB data
- Adds logout cleanup for application DB data

## Test Scenarios by Component

### 1. PWA Data Sync Service Enhancement

#### 1.1 Application Database Table Sync

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.1a-UNIT-001 | Unit | P0 | `syncApplicationTable` method syncs speaker_assignments | Core functionality for new feature |
| 2.1a-UNIT-002 | Unit | P0 | `syncApplicationTable` method syncs agenda_item_metadata | Core functionality for new feature |
| 2.1a-UNIT-003 | Unit | P0 | `syncApplicationTable` method syncs attendee_metadata | Core functionality for new feature |
| 2.1a-UNIT-004 | Unit | P0 | `syncApplicationTable` handles database errors gracefully | Error handling is critical |
| 2.1a-UNIT-005 | Unit | P1 | `syncAllData` includes application tables in sync process | Integration with existing sync |
| 2.1a-UNIT-006 | Unit | P1 | `getOfflineDataStatus` includes application tables | Status reporting completeness |

#### 1.2 Cache Management

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.1a-UNIT-007 | Unit | P0 | `cacheTableData` method is public for admin service | API contract for integration |
| 2.1a-UNIT-008 | Unit | P1 | `debugCachedData` includes application tables | Debugging support |

### 2. Admin Service Enhancement

#### 2.1 Local Storage Integration

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.1a-INT-001 | Integration | P0 | `getAgendaItemsWithAssignments` loads from local storage first | Core enhancement functionality |
| 2.1a-INT-002 | Integration | P0 | `assignSpeakerToAgendaItem` updates local storage | Data consistency requirement |
| 2.1a-INT-003 | Integration | P0 | `removeSpeakerFromAgendaItem` updates local storage | Data consistency requirement |
| 2.1a-INT-004 | Integration | P1 | `updateLocalSpeakerAssignments` merges data correctly | Complex data manipulation |
| 2.1a-INT-005 | Integration | P1 | `removeLocalSpeakerAssignment` filters data correctly | Complex data manipulation |

#### 2.2 Database Fallback

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.1a-INT-006 | Integration | P0 | Admin operations fallback to database when local storage fails | Resilience requirement |
| 2.1a-INT-007 | Integration | P1 | Database errors don't break local storage operations | Error isolation |

### 3. Data Clearing Service Enhancement

#### 3.1 Logout Cleanup

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.1a-UNIT-009 | Unit | P0 | `clearLocalStorageData` includes application database keys | Security requirement |
| 2.1a-UNIT-010 | Unit | P1 | `verifyDataCleared` checks application database data | Verification completeness |

### 4. End-to-End Integration

#### 4.1 Complete Admin Workflow

| ID | Level | Priority | Test | Justification |
|---|---|---|---|---|
| 2.1a-E2E-001 | E2E | P0 | Admin can assign speakers with data persisting locally and in DB | Critical user journey |
| 2.1a-E2E-002 | E2E | P0 | Admin operations work offline with local storage | Offline capability |
| 2.1a-E2E-003 | E2E | P1 | Background sync updates local storage with DB changes | Data freshness |
| 2.1a-E2E-004 | E2E | P1 | Logout clears all application database data | Security compliance |

## Detailed Test Scenarios

### Unit Tests (12 scenarios)

#### PWA Data Sync Service Tests

```typescript
describe('Application Database Sync Enhancement', () => {
  describe('syncApplicationTable', () => {
    it('2.1a-UNIT-001: should sync speaker_assignments table', async () => {
      // Mock applicationDb.from('speaker_assignments').select('*')
      // Verify data is cached with correct key
      // Verify cache structure matches expected format
    });

    it('2.1a-UNIT-002: should sync agenda_item_metadata table', async () => {
      // Mock applicationDb.from('agenda_item_metadata').select('*')
      // Verify data is cached with correct key
    });

    it('2.1a-UNIT-003: should sync attendee_metadata table', async () => {
      // Mock applicationDb.from('attendee_metadata').select('*')
      // Verify data is cached with correct key
    });

    it('2.1a-UNIT-004: should handle database errors gracefully', async () => {
      // Mock applicationDb to throw error
      // Verify error is caught and re-thrown
      // Verify no partial data is cached
    });
  });

  describe('Enhanced syncAllData', () => {
    it('2.1a-UNIT-005: should include application tables in sync process', async () => {
      // Mock both regular and application table syncs
      // Verify both are called
      // Verify result includes application tables
    });
  });

  describe('Enhanced getOfflineDataStatus', () => {
    it('2.1a-UNIT-006: should include application tables in status', async () => {
      // Mock cached data for all tables including application tables
      // Verify status includes application table availability
    });
  });

  describe('API Changes', () => {
    it('2.1a-UNIT-007: should expose cacheTableData method publicly', async () => {
      // Verify cacheTableData is accessible from admin service
      // Test method can be called with application table data
    });

    it('2.1a-UNIT-008: should include application tables in debug output', async () => {
      // Mock debugCachedData call
      // Verify application tables are included in debug output
    });
  });
});
```

#### Data Clearing Service Tests

```typescript
describe('Application Database Cleanup Enhancement', () => {
  describe('clearLocalStorageData', () => {
    it('2.1a-UNIT-009: should include application database keys in cleanup', async () => {
      // Mock localStorage with application DB keys
      // Verify all application DB keys are removed
      // Verify other keys are not affected
    });
  });

  describe('verifyDataCleared', () => {
    it('2.1a-UNIT-010: should check application database data in verification', async () => {
      // Mock localStorage with remaining application DB data
      // Verify verification fails when application DB data exists
      // Verify verification passes when application DB data is cleared
    });
  });
});
```

### Integration Tests (8 scenarios)

#### Admin Service + PWA Sync Integration

```typescript
describe('Admin Service + PWA Sync Integration', () => {
  describe('Local Storage Integration', () => {
    it('2.1a-INT-001: should load speaker assignments from local storage first', async () => {
      // Mock PWA sync service to return cached speaker assignments
      // Call getAgendaItemsWithAssignments
      // Verify assignments are loaded from cache, not database
    });

    it('2.1a-INT-002: should update local storage when assigning speakers', async () => {
      // Mock admin service assignSpeakerToAgendaItem
      // Verify PWA sync service cacheTableData is called
      // Verify local storage is updated with new assignment
    });

    it('2.1a-INT-003: should update local storage when removing speakers', async () => {
      // Mock admin service removeSpeakerFromAgendaItem
      // Verify PWA sync service cacheTableData is called
      // Verify local storage is updated with removed assignment
    });

    it('2.1a-INT-004: should merge speaker assignments data correctly', async () => {
      // Mock existing assignments in local storage
      // Add new assignment via admin service
      // Verify merge logic works correctly
    });

    it('2.1a-INT-005: should filter speaker assignments data correctly', async () => {
      // Mock multiple assignments in local storage
      // Remove specific assignment via admin service
      // Verify filter logic works correctly
    });
  });

  describe('Database Fallback', () => {
    it('2.1a-INT-006: should fallback to database when local storage fails', async () => {
      // Mock PWA sync service to throw error
      // Mock application database service to succeed
      // Verify admin operations still work
    });

    it('2.1a-INT-007: should isolate database errors from local storage operations', async () => {
      // Mock database to fail, local storage to succeed
      // Verify local storage operations continue
      // Verify database errors are logged but don't break flow
    });
  });
});
```

### End-to-End Tests (4 scenarios)

```typescript
describe('Application Database Enhancement E2E', () => {
  it('2.1a-E2E-001: should complete admin speaker assignment workflow', async () => {
    // 1. Login to admin panel
    // 2. Assign speaker to agenda item
    // 3. Verify data appears in local storage
    // 4. Verify data appears in database
    // 5. Refresh page and verify data persists
  });

  it('2.1a-E2E-002: should work offline with local storage', async () => {
    // 1. Go offline
    // 2. Assign speakers via admin panel
    // 3. Verify operations work with local storage only
    // 4. Go online and verify sync occurs
  });

  it('2.1a-E2E-003: should sync data in background', async () => {
    // 1. Make changes via admin panel
    // 2. Wait for background sync
    // 3. Verify local storage is updated with fresh data
    // 4. Verify database has latest changes
  });

  it('2.1a-E2E-004: should clear application database data on logout', async () => {
    // 1. Make admin changes
    // 2. Logout
    // 3. Verify all application database data is cleared
    // 4. Login again and verify no old data remains
  });
});
```

## Risk Coverage

| Risk ID | Risk Description | Mitigating Tests |
|---------|------------------|------------------|
| RISK-001 | Data inconsistency between local storage and database | 2.1a-INT-001, 2.1a-INT-002, 2.1a-INT-003 |
| RISK-002 | Silent failures in background sync | 2.1a-UNIT-004, 2.1a-INT-006, 2.1a-E2E-003 |
| RISK-003 | Data leakage on logout | 2.1a-UNIT-009, 2.1a-UNIT-010, 2.1a-E2E-004 |
| RISK-004 | Poor offline experience | 2.1a-INT-006, 2.1a-E2E-002 |
| RISK-005 | Performance degradation with large datasets | 2.1a-UNIT-005, 2.1a-INT-004, 2.1a-INT-005 |

## Recommended Execution Order

1. **P0 Unit Tests** (Fail fast for core functionality)
   - 2.1a-UNIT-001 through 2.1a-UNIT-004 (Application DB sync)
   - 2.1a-UNIT-007 (API contract)
   - 2.1a-UNIT-009 (Security cleanup)

2. **P0 Integration Tests** (Core integration flows)
   - 2.1a-INT-001, 2.1a-INT-002, 2.1a-INT-003 (Local storage integration)
   - 2.1a-INT-006 (Database fallback)

3. **P0 E2E Tests** (Critical user journeys)
   - 2.1a-E2E-001 (Complete admin workflow)
   - 2.1a-E2E-004 (Security compliance)

4. **P1 Tests** (Secondary functionality)
   - Remaining unit and integration tests
   - 2.1a-E2E-002, 2.1a-E2E-003 (Offline and sync)

5. **P2 Tests** (Nice-to-have)
   - 2.1a-UNIT-008 (Debug support)

## Implementation Notes

### Test Data Management
- Use consistent test data across all tests
- Implement proper cleanup between tests
- Mock external dependencies (Supabase, localStorage)

### Mock Strategy
- Mock `applicationDb` for application database operations
- Mock `pwaDataSyncService` for admin service integration tests
- Mock `localStorage` for storage operations
- Use real components for E2E tests where possible

### Performance Considerations
- Unit tests should run in <100ms each
- Integration tests should run in <500ms each
- E2E tests should run in <2s each
- Use timeouts appropriately for async operations

## Quality Gates

- **Unit Test Gate:** All P0 unit tests must pass, ≥85% code coverage for new functionality
- **Integration Test Gate:** All P0 integration tests must pass, database operations verified
- **E2E Test Gate:** All P0 E2E tests must pass, critical user journeys validated
- **Performance Gate:** No test should exceed timeout limits
- **Security Gate:** All data clearing tests must pass

## Success Criteria

- ✅ All 24 test scenarios implemented and passing
- ✅ 100% P0 test coverage achieved
- ✅ No critical bugs in application database functionality
- ✅ Performance meets requirements
- ✅ Security requirements satisfied
