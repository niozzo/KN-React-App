# Story 8.9: Remove Unused Database Tables from Login Sync

## Status
**Draft**

## Story
**As a** conference attendee,
**I want** faster login times,
**so that** I can quickly access the app and start using it without delays.

## Context
Analysis of the login process revealed that 3 database tables are being synced during login but are never used by the application:
- `hotels` table - getAllHotels() function exists but is never called
- `agenda_item_metadata` table - Override functionality was removed from admin panel
- `dining_item_metadata` table - No UI components consume this data

Removing these unused tables will reduce login database queries from 10 to 7 (30% reduction) with zero risk to functionality.

## Acceptance Criteria
1. Login database queries reduced from 10 to 7 tables
2. Hotels table and all related code removed from codebase
3. agenda_item_metadata table and title override logic removed
4. dining_item_metadata table and related code removed
5. Login flow completes successfully without errors
6. Agenda items display with correct titles (from main database)
7. Dining options display with correct names (from main database)
8. No console errors about missing cache keys
9. Settings page data refresh functionality works correctly
10. No breaking changes to existing functionality

## Tasks / Subtasks

- [ ] Task 1: Remove tables from login sync configuration (AC: 1)
  - [ ] Remove `'hotels'` from `tableToSync` array in `serverDataSyncService.ts`
  - [ ] Remove `'agenda_item_metadata'` from `applicationTablesToSync` array
  - [ ] Remove `'dining_item_metadata'` from `applicationTablesToSync` array

- [ ] Task 2: Remove hotels-related code (AC: 2)
  - [ ] Remove hotels filtering logic from `serverDataSyncService.ts` (lines 130-135)
  - [ ] Remove `syncHotels()` method from `serverDataSyncService.ts` (lines 623-627)
  - [ ] Remove `getAllHotels()` function from `dataService.ts`
  - [ ] Delete `hotelService.ts` file (unused service)
  - [ ] Remove `Hotel` interface from `database.ts`
  - [ ] Remove `getAllHotels` method from service interface in `database.ts` (line 289)
  - [ ] Remove `'kn_cache_hotels'` from cache clearing in `SettingsPage.jsx` (line 112)

- [ ] Task 3: Remove agenda_item_metadata code and override logic (AC: 3, 6)
  - [ ] Remove metadata fetch from `agendaService.ts` (lines 209-211)
  - [ ] Remove title override logic from `agendaService.ts` (lines 221-225)
  - [ ] Update code to use `item.title` directly instead of `finalTitle`
  - [ ] Remove `syncAgendaItemMetadata()` method from `applicationDatabaseService.ts`
  - [ ] Remove `AgendaItemMetadata` interface from `applicationDatabaseService.ts` (lines 403-410)
  - [ ] Remove agenda_item_metadata from bulk operations
  - [ ] Remove agenda_item_metadata from `dataInitializationService.ts` (line 132)
  - [ ] Remove agendaItemMetadata cache check from `dataInitializationService.ts` (line 98)
  - [ ] Remove from cache metrics in `dataInitializationService.ts` (line 112)

- [ ] Task 4: Remove dining_item_metadata code and override logic (AC: 4, 7)
  - [ ] Remove metadata fetch from `adminService.ts` (lines 95-96)
  - [ ] Remove title override logic from `adminService.ts` (lines 99-104)
  - [ ] Update code to use `option.name` directly instead of `finalTitle`
  - [ ] Remove dining_item_metadata cache invalidation from `adminService.ts` (line 171)
  - [ ] Remove `syncDiningItemMetadata()` method from `applicationDatabaseService.ts` (lines 284-297)
  - [ ] Remove dining_item_metadata from bulk operations
  - [ ] Remove dining_item_metadata from `dataInitializationService.ts` (line 132)

- [ ] Task 5: Remove table mapping entries (AC: 1)
  - [ ] Remove `agenda_item_metadata` entry from `tableMappings.ts`
  - [ ] Remove `dining_item_metadata` entry from `tableMappings.ts` (line 11)

- [ ] Task 6: Update tests and documentation (AC: 5, 8, 9, 10)
  - [ ] Remove metadata-related test expectations from `adminService.integration.test.ts.skip`
  - [ ] Update `login-cache-optimization-findings.md` to reflect changes made
  - [ ] Test login flow completes successfully
  - [ ] Verify agenda items display correctly with original titles
  - [ ] Verify dining options display correctly with original names
  - [ ] Verify no console errors about missing cache keys
  - [ ] Test Settings page data refresh works
  - [ ] Confirm no references to removed tables remain in active code

## Dev Notes

### Performance Impact
- **Current state**: 10 database queries during login
- **After optimization**: 7 database queries during login (-30%)
- **Estimated login time improvement**: 20-30% faster
- **Risk level**: Zero (all removed code is unused)

### Tables Being Removed

#### 1. hotels Table
- **Reason**: `getAllHotels()` function exists but is never called anywhere in the application
- **Evidence**: No UI components use hotel data, SettingsPage only references cache key for clearing

#### 2. agenda_item_metadata Table
- **Reason**: Admin panel override functionality was removed
- **Fields**: `id`, `title`, `start_time`, `end_time`, `time_override_enabled`, `last_synced`
- **Current usage**: Title override logic in `agendaService.ts` that should be removed

#### 3. dining_item_metadata Table
- **Reason**: No UI components consume this data
- **Fields**: `id`, `title`, `date`, `time`, `last_synced`
- **Current usage**: Title override logic in `adminService.ts` that should be removed

### Source Tree Context

**Services to modify:**
- `src/services/serverDataSyncService.ts` - Main sync configuration
- `src/services/dataService.ts` - Data access layer
- `src/services/agendaService.ts` - Agenda data enrichment
- `src/services/adminService.ts` - Admin data operations
- `src/services/applicationDatabaseService.ts` - Application DB operations
- `src/services/dataInitializationService.ts` - Cache initialization

**Services to delete:**
- `src/services/hotelService.ts` - Unused hotel service

**Types to modify:**
- `src/types/database.ts` - Remove Hotel interface

**Config to modify:**
- `src/config/tableMappings.ts` - Remove metadata table mappings

**Pages to modify:**
- `src/pages/SettingsPage.jsx` - Remove hotels cache reference

### Important Notes
- The homepage time override feature (`TimeOverride` component with `kn_time_override` localStorage) is a separate dev tool and should NOT be removed
- Only remove the application database metadata override functionality (agenda_item_metadata and dining_item_metadata)
- After removing override logic, agenda items will display titles directly from the main database
- After removing override logic, dining options will display names directly from the main database

### Testing

#### Test Standards
- **Test file location**: `src/__tests__/services/`
- **Test frameworks**: Vitest, React Testing Library
- **Integration tests**: Update `adminService.integration.test.ts.skip` to remove metadata expectations

#### Validation Steps
1. Login flow test - verify completes without errors
2. Agenda display test - verify titles display correctly from main DB
3. Dining display test - verify names display correctly from main DB
4. Console error check - verify no missing cache key errors
5. Settings refresh test - verify data refresh functionality works
6. Code search - confirm no references to removed tables remain

#### Performance Testing
- Measure login time before and after changes
- Verify 30% reduction in database queries
- Confirm no regression in data display accuracy

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Initial story creation from analysis findings | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

