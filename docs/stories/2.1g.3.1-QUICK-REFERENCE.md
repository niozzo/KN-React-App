# Story 2.1g.3.1: Quick Reference Guide

## 🎯 The Problem (One Sentence)
**Dining events with assigned seating show NO seat information because lines 536-539 of `useSessionData.js` explicitly exclude them.**

## ✅ The Solution (One Sentence)
**Remove the dining exclusion check and add dining-specific seat matching logic to treat dining events the same as agenda items.**

---

## 📍 Current State Analysis

### What's Working ✅
- ✅ Agenda item seat assignments display correctly
- ✅ Dining events with "open seating" display correctly
- ✅ SessionCard has all display logic ready
- ✅ Seat map navigation works for agenda items
- ✅ localStorage caching infrastructure exists

### What's Broken ❌
- ❌ Lines 536-539 in `useSessionData.js` return dining events WITHOUT seat enhancement
- ❌ Dining events with `seating_type: "assigned"` show NO seat information
- ❌ No "pending assignment" message for unassigned dining seats

---

## 🔧 The Fix (3 Key Changes)

### 1. Data Service (Already Works!)
**File**: `src/services/dataService.ts` (Lines 295-329)

✅ **Good News**: `getAttendeeSeatAssignments()` already fetches ALL seat assignments from the `seat_assignments` table (which includes both agenda and dining). No changes needed here!

```typescript
// Current implementation (Lines 295-329)
export const getAttendeeSeatAssignments = async (attendeeId: string) => {
  // Already fetches ALL seat assignments (agenda + dining)
  const cachedData = localStorage.getItem('kn_cache_seat_assignments')
  // ... filters by attendeeId
  return attendeeSeats // ✅ Includes dining seat assignments!
}
```

**Action**: Verify this during Phase 1, likely no changes needed!

---

### 2. Hook Enhancement (The Main Fix)
**File**: `src/hooks/useSessionData.js` (Lines 533-554)

**Current Code (BROKEN)**:
```javascript
const enhanceEventWithSeatInfo = (event) => {
  if (!event || !seatAssignments.length) return event || null;
  
  // 🚫 THIS IS THE PROBLEM - dining events are excluded
  if (event.type === 'dining') {
    return event;
  }
  
  // Find seat assignment for this session (agenda items only)
  const seatAssignment = seatAssignments.find(seat => 
    seat.seating_configuration_id === event.seating_configuration_id
  );
  
  return {
    ...event,
    seatInfo: seatAssignment ? {
      table: seatAssignment.table_name,
      seat: seatAssignment.seat_number,
      position: seatAssignment.seat_position
    } : null
  };
};
```

**New Code (FIXED)**:
```javascript
const enhanceEventWithSeatInfo = (event) => {
  if (!event || !seatAssignments.length) return event || null;
  
  // ✅ REMOVE THE DINING EXCLUSION - let all events be enhanced
  
  // Find seat assignment for this event (works for BOTH types now)
  const seatAssignment = seatAssignments.find(seat => {
    // The seat_assignments table is linked via seating_configuration_id
    // which can be for EITHER agenda items OR dining options
    return seat.seating_configuration_id === event.seating_configuration_id;
  });
  
  return {
    ...event,
    seatInfo: seatAssignment ? {
      table: seatAssignment.table_name,
      seat: seatAssignment.seat_number,
      position: seatAssignment.seat_position
    } : null
  };
};
```

**Key Insight**: The `seating_configuration_id` field exists on BOTH agenda items and dining options, and seat_assignments link to it. By removing the exclusion, the existing logic works for both!

---

### 3. Display Enhancement (Add Pending Message)
**File**: `src/components/session/SessionCard.jsx` (After line 443)

**Current Code**:
```javascript
// Lines 397-443: Existing seat display (WORKS!)
{seatInfo && (
  <div className="seat-assignment" onClick={...}>
    <div className="seat-label">Your Seat</div>
    <div className="seat-details">
      <span>{seatInfo.table} • Seat {seatInfo.seat}</span>
      <span className="seat-map-link">Find my seat</span>
    </div>
  </div>
)}
// ⬇️ ADD THIS BELOW ⬇️
```

**Add After Line 443**:
```javascript
{/* Show "pending" message for assigned seating without assignment */}
{session.type === 'dining' && 
 session.seating_type === 'assigned' && 
 !seatInfo && (
  <div 
    className="seat-assignment"
    style={{ 
      cursor: 'default',
      background: 'white',
      borderRadius: 'var(--radius-md)',
      padding: 'var(--space-sm)',
      marginTop: 'var(--space-sm)',
      border: '1px solid var(--border-light)',
      opacity: 0.8
    }}
  >
    <div className="seat-label" style={{ 
      fontSize: 'var(--text-sm)', 
      fontWeight: '600',
      color: 'var(--text-secondary)',
      marginBottom: 'var(--space-xs)'
    }}>
      Seat Assignment
    </div>
    <div className="seat-details">
      <span style={{ 
        fontSize: 'var(--text-base)', 
        color: 'var(--text-secondary)',
        fontStyle: 'italic'
      }}>
        Assignment pending
      </span>
    </div>
  </div>
)}
```

---

## 📊 Implementation Checklist

### Phase 1: Investigation (1 hour)
- [ ] Query database to confirm seat_assignments includes dining
- [ ] Verify seating_configuration_id exists on dining_options
- [ ] Check that current getAttendeeSeatAssignments fetches dining assignments
- [ ] Document findings

### Phase 2: Code Changes (2 hours)
- [ ] **useSessionData.js**: Remove lines 536-539 (dining exclusion)
- [ ] **SessionCard.jsx**: Add "pending assignment" display (after line 443)
- [ ] Test locally with sample data

### Phase 3: Testing (3 hours)
- [ ] Write unit tests for useSessionData enhancement
- [ ] Write unit tests for SessionCard display
- [ ] Write integration tests for full data flow
- [ ] Achieve 80% line coverage, 70% branch coverage

### Phase 4: Validation (1 hour)
- [ ] Test on Home page (now/next cards)
- [ ] Test on Schedule page
- [ ] Test seat map navigation
- [ ] Validate all 9 acceptance criteria

### Phase 5: Documentation (30 min)
- [ ] Update Dev Agent Record in story
- [ ] Create completion report
- [ ] Update story status to "Complete"

---

## 🧪 Testing Strategy

### Unit Tests Needed

**File**: `src/__tests__/hooks/useSessionData-dining-seats.test.js`
```javascript
describe('useSessionData - Dining Seat Enhancement', () => {
  it('should enhance dining event with seat assignment')
  it('should return dining event without seatInfo when no assignment exists')
  it('should not break agenda item seat assignments')
  it('should handle missing seating_configuration_id')
})
```

**File**: `src/__tests__/components/SessionCard-dining-seats.test.jsx`
```javascript
describe('SessionCard - Dining Seat Display', () => {
  it('should display dining seat assignment')
  it('should display "pending" message when assigned but no seat')
  it('should display "open seating" for open dining events')
  it('should navigate to seat map when clicking seat')
})
```

### Integration Tests Needed

**File**: `src/__tests__/integration/dining-seat-assignment.test.tsx`
```javascript
describe('Dining Seat Assignment - Full Flow', () => {
  it('should load dining seat assignments from API')
  it('should cache dining seat assignments in localStorage')
  it('should display dining seats on Home page')
  it('should display dining seats on Schedule page')
})
```

---

## 🎯 Acceptance Criteria Validation

| AC# | Requirement | How to Validate | Status |
|-----|-------------|-----------------|--------|
| AC-1 | Show "Table X • Seat Y" for assigned dining | Test with dining event that has seat | 🔲 |
| AC-2 | Show "Open seating" for open dining | Already works, regression test | ✅ |
| AC-3 | Show pending message when no assignment | Test with assigned dining, no seat | 🔲 |
| AC-4 | Consistent on Home & Schedule | Visual inspection both pages | 🔲 |
| AC-5 | Clickable seat navigates to map | Click test, verify navigation | 🔲 |
| AC-6 | Visual consistency | Compare agenda vs dining styling | 🔲 |
| AC-7 | Data integration working | Check localStorage cache | 🔲 |
| AC-8 | Unit tests 80% coverage | Run coverage report | 🔲 |
| AC-9 | Integration tests 70% coverage | Run coverage report | 🔲 |

---

## 🔍 Database Schema Reference

### Relevant Tables

**seating_configurations**
```sql
id                      UUID PRIMARY KEY
agenda_item_id          UUID (nullable) -- For agenda items
dining_option_id        UUID (nullable) -- For dining events
seating_type           TEXT ('open' | 'assigned')
has_seating            BOOLEAN
```

**seat_assignments**
```sql
id                          UUID PRIMARY KEY
seating_configuration_id    UUID -- Links to seating_configurations
attendee_id                 UUID -- Links to attendees
table_name                  TEXT
seat_number                 INTEGER
seat_position               JSONB
```

**Join Logic**:
```sql
-- For dining events:
dining_options.id 
  → seating_configurations.dining_option_id 
  → seat_assignments.seating_configuration_id

-- For agenda items:
agenda_items.id 
  → seating_configurations.agenda_item_id 
  → seat_assignments.seating_configuration_id
```

---

## 💡 Key Insights

1. **No Data Service Changes Needed**: The current `getAttendeeSeatAssignments()` already fetches all seat assignments (agenda + dining). The problem is purely in the hook logic.

2. **Single Field Unifies Both**: The `seating_configuration_id` field exists on BOTH `agenda_items` and `dining_options` tables, creating a unified relationship to `seat_assignments`.

3. **Minimal Code Changes**: This is a 4-line deletion (remove exclusion) + 30-line addition (pending message). Very low risk!

4. **SessionCard Already Ready**: The display component already handles `seatInfo` correctly. Once the hook populates it, everything works.

5. **Navigation Already Works**: The seat map navigation logic works for any event with `seatInfo`, no changes needed.

---

## 🚀 Quick Start Commands

```bash
# Run tests
npm test -- useSessionData
npm test -- SessionCard

# Run coverage
npm run test:coverage -- useSessionData
npm run test:coverage -- SessionCard

# Run all tests
npm test

# Start dev server
npm run dev
```

---

## 📚 Related Documentation

- **Full Plan**: `2.1g.3.1-IMPLEMENTATION-PLAN.md`
- **Story**: `2.1g.3.1-dining-seat-assignment-display.md`
- **Architecture**: `../architecture/tech-stack.md`
- **Database Schema**: `../architecture/database-schema.md`
- **Testing Standards**: `../architecture/coding-standards.md`

---

## 🎭 BMad Agent Commands

```bash
*agent dev         # For implementation
*agent qa          # For testing and validation
*agent architect   # For architecture questions
*agent po          # For requirements clarification
```

---

*This quick reference provides the essential information for implementing Story 2.1g.3.1 efficiently.*

