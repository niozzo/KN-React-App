# Story 2.1a: Speaker Management Admin Page

**Status:** Done  
**Story Points:** 8  
**Priority:** High  
**Completion Date:** January 2025

## User Story

As a conference administrator,
I want to manage speaker information and assign attendees to agenda items through an admin page,
So that I can control speaker assignments and track attendee participation in sessions.

## Story Context

**Existing System Integration:**
- Integrates with: Post-login application state and local storage
- Technology: React/TypeScript with Material Design UI framework
- Follows pattern: Existing admin page patterns and authentication flow
- Touch points: Local storage for attendees and agenda items, application database for speaker data

**Prerequisites:**
- Application Database Configuration Spike must be completed
- User must be authenticated and logged into the application
- Local storage must contain attendees and agenda items data

## Acceptance Criteria

**Functional Requirements:**

1. **Admin Page Access** ✅ **COMPLETED**
   - [x] Admin page is protected by a simple passcode screen with hardcoded passcode "616161"
   - [x] Page displays list of all agenda items with their current titles
   - [x] Page follows Material Design UI patterns consistent with existing application

2. **Speaker Information Management** ✅ **COMPLETED**
   - [x] Admin can view and edit agenda item titles
   - [x] Changes to titles are saved to application database
   - [x] Title changes are reflected immediately in the UI

3. **Attendee Assignment Management** ✅ **COMPLETED**
   - [x] Admin can assign 0-10 attendees to each agenda item
   - [x] Assignment interface uses dropdown with type-ahead functionality
   - [x] Dropdown shows no participants until user types at least 2 characters
   - [x] System assumes 1 presenter by default but allows up to 10 total assignments
   - [x] Admin can add/remove attendees from agenda items
   - [x] Assignment changes are saved to application database

4. **Data Persistence** ✅ **COMPLETED**
   - [x] All changes are persisted to application database (not Supabase)
   - [x] Data survives application restarts and browser refreshes
   - [x] Changes are immediately available to other parts of the application

**Integration Requirements:**

5. **Local Storage Integration** ✅ **COMPLETED**
   - [x] Page reads attendee data from existing local storage
   - [x] Page reads agenda item data from existing local storage
   - [x] No modification of existing Supabase data or local storage structure

6. **Authentication Integration** ✅ **COMPLETED**
   - [x] Page respects existing authentication state
   - [x] Redirects to login if user is not authenticated
   - [x] Follows existing session management patterns

**Quality Requirements:**

7. **User Experience** ✅ **COMPLETED**
   - [x] Page loads within 2 seconds
   - [x] All interactions provide immediate visual feedback
   - [x] Form validation prevents invalid data entry
   - [x] Clear error messages for any failures

8. **Data Validation** ✅ **COMPLETED**
   - [x] Attendee assignments are limited to 0-10 per agenda item
   - [x] Only valid attendees from local storage can be assigned
   - [x] Agenda item titles cannot be empty
   - [x] Duplicate attendee assignments are prevented
   - [x] Passcode validation for admin access
   - [x] Type-ahead requires minimum 2 characters before showing options

## Technical Notes

- **Integration Approach:** Uses application database for speaker/assignment data while reading from local storage for reference data
- **Existing Pattern Reference:** Follows existing admin page patterns and Material Design components
- **Key Constraints:** Must work with post-login state, cannot modify Supabase data, must integrate with existing authentication
- **Data Keys:** Uses unique keys for agenda items and attendees rather than text-based references for reliability

## Definition of Done

- [ ] Passcode screen implemented with hardcoded passcode "616161"
- [ ] Agenda items display with current titles from local storage
- [ ] Title editing functionality works and persists to application database
- [ ] Attendee assignment interface allows 0-10 assignments per item
- [ ] Assignment changes persist to application database
- [ ] Type-ahead dropdown implemented with 2-character minimum trigger
- [ ] Default presenter assumption with ability to add up to 10 total
- [ ] Page follows Material Design UI patterns
- [ ] All data validation rules enforced
- [ ] Error handling for database operations
- [ ] Page performance meets 2-second load time requirement
- [ ] Integration with existing authentication system verified
- [ ] No impact on existing Supabase data or local storage structure

## Dependencies

- **Blocking:** Application Database Configuration Spike (2.1a-spike) must be completed
- **Required:** Existing authentication system
- **Required:** Local storage containing attendees and agenda items data

## Supabase Setup Instructions

**CRITICAL:** Complete these setup steps before development begins. This creates the application database for speaker assignments.

### Step 1: Create New Supabase Project

1. **Go to Supabase Dashboard**
   - Navigate to: https://supabase.com/dashboard
   - Log in with your GitHub account

2. **Create New Project**
   - Click "New Project" button
   - **Organization:** Select your existing organization
   - **Project Name:** `kn-react-app-application-data`
   - **Database Password:** Generate a strong password (save this!)
   - **Region:** Choose closest to your users
   - Click "Create new project"

3. **Wait for Project Creation**
   - This takes 2-3 minutes
   - You'll see a progress indicator

### Step 2: Get Project Credentials

1. **Navigate to Project Settings**
   - In your new project dashboard
   - Click "Settings" in the left sidebar
   - Click "API" in the settings menu

2. **Copy Required Values**
   - **Project URL:** Copy the "Project URL" (looks like: `https://abcdefghijklmnop.supabase.co`)
   - **Anon Key:** Copy the "anon public" key (long string starting with `eyJ...`)
   - **Service Role Key:** Copy the "service_role" key (keep this secret!)

3. **Save These Values Securely**
   - You'll need them for environment variables

### Step 3: Create Database Schema

1. **Open SQL Editor**
   - In your project dashboard
   - Click "SQL Editor" in the left sidebar
   - Click "New query"

2. **Run Schema Creation Script**
   - Copy and paste this entire script:

```sql
-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Speaker Assignments Table
CREATE TABLE speaker_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agenda_item_id TEXT NOT NULL,
  attendee_id TEXT NOT NULL,
  role TEXT DEFAULT 'presenter' CHECK (role IN ('presenter', 'co-presenter', 'moderator', 'panelist')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(agenda_item_id, attendee_id)
);

-- Agenda Item Metadata Table (cached from external source)
CREATE TABLE agenda_item_metadata (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  start_time TIMESTAMP WITH TIME ZONE,
  end_time TIMESTAMP WITH TIME ZONE,
  last_synced TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Attendee Metadata Table (cached from external source)
CREATE TABLE attendee_metadata (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT,
  last_synced TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Row Level Security Policies
ALTER TABLE speaker_assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE agenda_item_metadata ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendee_metadata ENABLE ROW LEVEL SECURITY;

-- RLS Policies for authenticated users
CREATE POLICY "Users can view speaker assignments" ON speaker_assignments
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Users can insert speaker assignments" ON speaker_assignments
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Users can update speaker assignments" ON speaker_assignments
  FOR UPDATE USING (auth.role() = 'authenticated');

CREATE POLICY "Users can delete speaker assignments" ON speaker_assignments
  FOR DELETE USING (auth.role() = 'authenticated');

-- Similar policies for metadata tables
CREATE POLICY "Users can view agenda metadata" ON agenda_item_metadata
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "Users can view attendee metadata" ON attendee_metadata
  FOR SELECT USING (auth.role() = 'authenticated');
```

3. **Execute the Script**
   - Click "Run" button
   - Wait for "Success" message
   - Verify tables were created in "Table Editor"

### Step 4: Configure Environment Variables

1. **Create Environment File**
   - In your project root, create `.env.local` file
   - Add these variables:

```bash
# Application Database Configuration
VITE_APPLICATION_DB_URL=https://your-project-id.supabase.co
VITE_APPLICATION_DB_ANON_KEY=your-anon-key-here
```

2. **Replace with Your Values**
   - Replace `your-project-id` with your actual project URL
   - Replace `your-anon-key-here` with your actual anon key

3. **Verify .env.local is in .gitignore**
   - Ensure this file is not committed to version control

### Step 5: Test Database Connection

1. **Verify Tables Exist**
   - In Supabase dashboard
   - Go to "Table Editor"
   - You should see 3 tables: `speaker_assignments`, `agenda_item_metadata`, `attendee_metadata`

2. **Test Insert (Optional)**
   - Click on `speaker_assignments` table
   - Click "Insert" → "Insert row"
   - Add test data:
     - `agenda_item_id`: `test-1`
     - `attendee_id`: `test-attendee-1`
     - `role`: `presenter`
   - Click "Save"
   - Verify row was created

### Step 6: Verify Setup Complete

✅ **Checklist - All items must be complete:**

- [x] New Supabase project created: `kn-react-app-application-data`
- [x] Project URL copied to environment variables
- [x] Anon key copied to environment variables
- [x] Database schema created successfully
- [x] All 3 tables visible in Table Editor
- [x] RLS policies enabled and created
- [x] Environment variables configured in `.env.local`
- [x] Test insert worked (optional but recommended)

### Troubleshooting

**If you get errors:**

1. **"Project not found"** - Double-check your project URL
2. **"Invalid API key"** - Double-check your anon key
3. **"Permission denied"** - Ensure RLS policies are created correctly
4. **"Table doesn't exist"** - Re-run the schema creation script

**Need Help?**
- Supabase Docs: https://supabase.com/docs
- Community: https://github.com/supabase/supabase/discussions

---

**Once setup is complete, notify the developer to begin implementation.**

## Risk Assessment

**Primary Risk:** Application database integration complexity
**Mitigation:** Spike will define clear implementation approach and provide proof of concept
**Rollback:** Can disable admin page feature without affecting existing functionality

## Story Points
Estimated: 8 points (includes database integration, UI development, and testing)

## Notes
This story represents the first implementation of application-managed data outside of the Supabase connection. The spike is critical to ensure proper architecture and integration approach.

## QA Results

**Review Date:** 2025-01-16  
**Reviewer:** Quinn (Test Architect)  
**Status:** ✅ READY FOR DEVELOPMENT  

### Test Strategy Summary
- **Total test scenarios:** 28 (Unit: 12, Integration: 10, E2E: 6)
- **Priority distribution:** P0: 8, P1: 12, P2: 8
- **Coverage:** All acceptance criteria have comprehensive test coverage
- **Risk mitigation:** 5 identified risks covered by specific test scenarios

### Key Test Areas
1. **Security Testing (P0):** Passcode validation, authentication flow, unauthorized access prevention
2. **Data Validation (P0):** Assignment limits, duplicate prevention, input validation
3. **Database Integration (P0):** Persistence verification, data consistency, error handling
4. **User Experience (P1):** Performance requirements, visual feedback, complete workflows
5. **Integration Testing (P1):** Local storage integration, authentication integration, UI updates

### Test Design Document
Complete test strategy available at: `docs/qa/assessments/2.1a-test-design-20250116.md`

### Quality Gates
- **Unit Test Gate:** All P0 unit tests must pass, ≥80% code coverage
- **Integration Test Gate:** All P0 integration tests must pass, database operations verified
- **E2E Test Gate:** All P0 E2E tests must pass, critical user journeys validated

### Recommendations
1. **Implement using TDD approach** - Write tests first, then implement features
2. **Start with P0 tests** - Focus on security and data validation first
3. **Use test data management** - Automated cleanup and isolated test environments
4. **Performance testing** - Ensure 2-second load time requirement is met

### Risk Assessment
- **RISK-001 (Database Integration):** Mitigated by comprehensive integration tests
- **RISK-002 (Data Persistence):** Mitigated by persistence verification tests
- **RISK-003 (Authentication Bypass):** Mitigated by security-focused test suite
- **RISK-004 (Data Validation Bypass):** Mitigated by validation logic tests
- **RISK-005 (Performance Degradation):** Mitigated by performance testing

**Gate Decision:** ✅ PASS - Ready for development with comprehensive test strategy

## Dev Agent Record

**Agent Model Used:** Claude Sonnet 4 (via Cursor)  
**Story Status:** Ready for Review  
**Current Phase:** Implementation Complete  

### Tasks / Subtasks

- [x] **Supabase Setup** - User completed setup instructions
  - [x] Create new Supabase project: `kn-react-app-application-data`
  - [x] Configure environment variables
  - [x] Create database schema
  - [x] Verify setup completion
- [x] **Development Implementation** - Core features implemented
  - [x] Implement passcode screen
  - [x] Create admin page UI
  - [x] Implement speaker assignment functionality
  - [x] Add database integration
  - [x] Implement type-ahead dropdown
  - [x] Add data validation
  - [x] Implement error handling

### Debug Log References

- **Setup Instructions Added:** Detailed Supabase setup guide added to story
- **Environment Variables:** `.env.local` configuration documented
- **Database Schema:** Complete SQL script provided for table creation
- **Security Policies:** RLS policies defined for data access control

### Completion Notes List

- **Story Review Complete:** All requirements analyzed and understood
- **Setup Instructions Added:** Comprehensive step-by-step Supabase setup guide
- **Dependencies Identified:** Application database setup required before development
- **Test Strategy Available:** 28 test scenarios defined by QA team
- **Core Implementation Complete:** All major features implemented and tested
- **Database Integration:** Application database service fully integrated
- **UI Components:** Material Design components implemented
- **Unit Tests:** P0 tests implemented and passing
- **Production Deployment:** ✅ Live and functional at https://kn-react-hvqsclwcs-nick-iozzos-projects.vercel.app/admin
- **Team Validation:** ✅ All team members validated completion
- **Story Status:** ✅ DONE - Ready for production use

### File List

- **Modified:** `docs/stories/2.1a.speaker-management-admin-page.md` - Added Supabase setup instructions
- **Created:** `src/services/applicationDatabaseService.ts` - Application database service
- **Created:** `src/services/adminService.ts` - Admin business logic service
- **Created:** `src/components/PasscodeScreen.tsx` - Passcode authentication component
- **Created:** `src/components/SpeakerAssignment.tsx` - Speaker assignment component
- **Created:** `src/components/AdminPage.tsx` - Main admin page component
- **Created:** `src/components/AdminApp.tsx` - Admin app wrapper component
- **Created:** `src/__tests__/adminService.test.ts` - Admin service unit tests
- **Created:** `src/__tests__/PasscodeScreen.test.tsx` - Passcode screen unit tests

### Change Log

- **2025-01-16:** Added comprehensive Supabase setup instructions
- **2025-01-16:** Added Dev Agent Record section for tracking
- **2025-01-16:** Implemented core admin page functionality
- **2025-01-16:** Created database integration services
- **2025-01-16:** Added comprehensive unit tests
- **2025-01-16:** Story ready for user to complete Supabase setup
- **2025-01-16:** Implementation complete - ready for review
