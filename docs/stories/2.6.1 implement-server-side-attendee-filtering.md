# Story 2.6.1: Implement Server-Side Attendee Data Filtering

**Story ID:** 2.6.1  
**Epic:** Data Privacy & Security  
**Priority:** High  
**Story Points:** 5  
**Status:** **Draft**

## User Story

As a **conference attendee**, I want **confidential personal information to be filtered at the server level** so that **sensitive data is never transmitted over the network and cannot be intercepted by network monitoring tools**.

## Acceptance Criteria

### Primary Security Requirements

1. **Server-Side Filtering Implementation:**
   - The `/api/attendees` endpoint must filter confidential fields before sending response
   - Only safe fields (as defined in `AttendeeCacheFilterService.SAFE_FIELDS`) are included in API responses
   - Confidential fields are never transmitted over the network

2. **Confidential Fields Filtered at Server:**
   - Contact Information: `business_phone`, `mobile_phone`, `email`
   - Travel & Accommodation: `check_in_date`, `check_out_date`, `hotel_selection`, `custom_hotel`, `room_type`
   - Personal Details: `has_spouse`, `dietary_requirements`, `is_spouse`, `spouse_details`
   - Address Information: `address1`, `address2`, `postal_code`, `city`, `state`, `country`, `country_code`
   - Assistant Information: `assistant_name`, `assistant_email`
   - System Identifiers: `idloom_id`, `access_code`

3. **Safe Fields Included in API Response:**
   - Basic Info: `id`, `first_name`, `last_name`, `title`, `company`, `bio`, `photo`, `salutation`
   - Event Functionality: `registration_status`, `registration_id`, `dining_selections`, `selected_breakouts`
   - Business Attributes: `attributes`, `is_cfo`, `is_apax_ep`, `primary_attendee_id`, `company_name_standardized`
   - System Fields: `last_synced_at`, `created_at`, `updated_at`

### Integration Requirements

4. **Client-Side Compatibility:**
   - Existing client-side filtering in `AttendeeCacheFilterService` continues to work
   - No changes required to client-side cache filtering logic
   - Existing `UnifiedCacheService` and `PWADataSyncService` continue to function

5. **API Response Format:**
   - API response structure remains unchanged (same JSON format)
   - Response includes same metadata (`success`, `count`, `timestamp`)
   - Only the `data` array contains filtered records

6. **Backward Compatibility:**
   - All existing API consumers continue to work without modification
   - No breaking changes to API contract
   - Client applications receive same data structure with fewer fields

### Quality Requirements

7. **Security Validation:**
   - Network traffic monitoring confirms no confidential data transmission
   - API responses can be verified to contain only safe fields
   - Server-side filtering is applied consistently across all attendee endpoints

8. **Performance Requirements:**
   - Server-side filtering adds minimal processing overhead
   - API response times remain within acceptable limits
   - Database queries remain efficient

## Tasks / Subtasks

- [ ] **Server-Side Filtering Implementation** (AC: 1, 2, 3)
  - [ ] Create server-side filtering utility function in `api/attendees.js`
  - [ ] Implement field filtering logic using same safe fields as client-side
  - [ ] Apply filtering to API response before sending to client
  - [ ] Add logging to confirm filtering is applied

- [ ] **API Integration Updates** (AC: 4, 5, 6)
  - [ ] Update `/api/attendees` endpoint to use server-side filtering
  - [ ] Ensure response format remains unchanged
  - [ ] Verify no breaking changes to API contract
  - [ ] Test API response structure and metadata

- [ ] **Security Validation** (AC: 7)
  - [ ] Create network monitoring test to verify no confidential data transmission
  - [ ] Add API response validation to confirm only safe fields are included
  - [ ] Document security improvement in architecture documentation

- [ ] **Testing & Documentation** (AC: 8)
  - [ ] Add unit tests for server-side filtering function
  - [ ] Create integration tests for API endpoint filtering
  - [ ] Update API documentation to reflect security enhancement
  - [ ] Performance test API response times

## Dev Notes

### Relevant Source Tree Info

**Files to Modify:**
- `api/attendees.js` - Main API endpoint requiring server-side filtering
- `src/services/attendeeCacheFilterService.ts` - Reference for safe fields list
- `docs/architecture/data-access-architecture.md` - Update security architecture

**Current Implementation:**
- Client-side filtering implemented in `AttendeeCacheFilterService.filterAttendeesArray()`
- API endpoint at `api/attendees.js` currently returns raw database data
- Filtering happens after data reaches browser in `PWADataSyncService.cacheTableData()`

**Security Gap Identified:**
- Network traffic contains full attendee data including confidential fields
- Server uses `select('*')` returning all database columns
- No server-side filtering before network transmission

**Integration Approach:**
- Reuse existing `SAFE_FIELDS` array from `AttendeeCacheFilterService`
- Apply filtering in API handler before JSON response
- Maintain existing API response structure and metadata

### Testing Standards

**Test File Location:** `src/__tests__/api/attendees-filtering.test.ts`

**Testing Requirements:**
- Unit tests for server-side filtering function
- Integration tests for API endpoint responses
- Security tests to verify no confidential data in network responses
- Performance tests for filtering overhead

**Test Patterns:**
- Use Jest for unit and integration testing
- Mock Supabase client for API testing
- Network monitoring tests using request/response inspection
- Performance benchmarking for filtering operations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation for server-side filtering implementation | Product Owner |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*
