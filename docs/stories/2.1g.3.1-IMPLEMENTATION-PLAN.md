# Story 2.1g.3.1: Dining Seat Assignment Display - Implementation Plan

## 📋 Overview

**Story**: 2.1g.3.1 - Dining Seat Assignment Display  
**Status**: Ready for Implementation  
**Created**: 2025-10-11  
**Developer**: BMad Orchestrator  

### Purpose
Complete the incomplete implementation from Story 2.1g.3 by enabling dining events to display seat assignments when `seating_type: "assigned"`.

### Problem Statement
The current implementation (Story 2.1g.3) explicitly excludes dining events from seat enhancement logic (lines 536-539 of `src/hooks/useSessionData.js`), causing dining events with assigned seating to show NO seat information, while open seating works correctly.

---

## 🎯 Acceptance Criteria

| AC# | Requirement | Implementation Area |
|-----|-------------|---------------------|
| AC-1 | Show "Your Seat: Table X • Seat Y" for assigned dining events | SessionCard Display |
| AC-2 | Show "Open seating" for open dining events | Already Working ✅ |
| AC-3 | Show pending message when no assignment exists | SessionCard Logic |
| AC-4 | Consistent display on Home & Schedule pages | SessionCard Usage |
| AC-5 | Clickable seat assignment navigates to seat map | SessionCard Interaction |
| AC-6 | Visual consistency with agenda seat assignments | SessionCard Styling |
| AC-7 | Query and cache dining seat assignments | DataService |
| AC-8 | Unit tests with 80% line coverage | Testing |
| AC-9 | Integration tests with 70% branch coverage | Testing |

---

## 📐 Architecture Overview

### Data Flow
```
┌─────────────────────┐
│ Supabase Database   │
│  - seating_configs  │ (with dining_option_id)
│  - seat_assignments │ (linked to configs)
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│  dataService.ts     │
│  - getAttendeeSeat  │
│    Assignments()    │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│   localStorage      │ (cache layer)
│  - seat assignments │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│  useSessionData.js  │
│  - enhance dining   │
│    with seat info   │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│   SessionCard.jsx   │
│  - Display seat     │
│  - Navigate to map  │
└─────────────────────┘
```

### Key Files to Modify
1. **src/services/dataService.ts** - Data fetching
2. **src/hooks/useSessionData.js** - Event enhancement
3. **src/components/session/SessionCard.jsx** - Display logic
4. **src/__tests__/** - Comprehensive tests

---

## 🔍 Phase 1: Data Structure Investigation

### Objectives
- Identify where dining seat assignments are stored
- Understand the relationship between dining events and seat assignments
- Document the data structure for future reference

### Tasks

#### 1.1 Query Database Structure
```sql
-- Examine seating_configurations for dining relationships
SELECT 
  id, 
  dining_option_id, 
  agenda_item_id, 
  seating_type, 
  has_seating 
FROM seating_configurations 
WHERE dining_option_id IS NOT NULL;

-- Examine seat_assignments structure
SELECT 
  id, 
  seating_configuration_id, 
  attendee_id, 
  table_name, 
  seat_number 
FROM seat_assignments 
LIMIT 5;

-- Check for dining-specific seat assignments
SELECT 
  sa.*, 
  sc.dining_option_id 
FROM seat_assignments sa
JOIN seating_configurations sc ON sa.seating_configuration_id = sc.id
WHERE sc.dining_option_id IS NOT NULL;
```

#### 1.2 Verify Data Relationships
Based on tech-stack.md, the expected schema is:
- **seating_configurations** has `dining_option_id` (nullable)
- **seat_assignments** has `seating_configuration_id` (references seating_configurations)
- Join logic: `dining_options.id → seating_configurations.dining_option_id → seat_assignments.seating_configuration_id`

#### 1.3 Document Findings
Create documentation of:
- Table names and key fields
- Join relationships
- Sample data queries
- Edge cases (multiple configs per dining event?)

### Success Criteria
- [ ] Clear understanding of data structure
- [ ] SQL queries validated with test data
- [ ] Documentation created for team reference

---

## 🔧 Phase 2: Data Service Enhancement

### Objectives
- Update `getAttendeeSeatAssignments()` to include dining seat assignments
- Implement caching for dining seat assignments
- Ensure backward compatibility with existing agenda item assignments

### Current Implementation
```typescript
// src/services/dataService.ts (current - agenda items only)
export const getAttendeeSeatAssignments = async (): Promise<SeatAssignment[]> => {
  // Currently only fetches agenda item seat assignments
  const { data, error } = await supabase
    .from('seat_assignments')
    .select('*')
    // Missing: dining event assignments
  
  return data || []
}
```

### New Implementation
```typescript
// src/services/dataService.ts (updated)
export const getAttendeeSeatAssignments = async (): Promise<SeatAssignment[]> => {
  try {
    // Check localStorage first (performance optimization)
    const cachedData = getCachedSeatAssignments()
    if (cachedData && !isExpired(cachedData)) {
      return cachedData.assignments
    }

    // Fetch ALL seat assignments (agenda + dining)
    const { data: assignments, error } = await supabase
      .from('seat_assignments')
      .select(`
        *,
        seating_configurations!inner (
          id,
          agenda_item_id,
          dining_option_id,
          seating_type
        )
      `)
    
    if (error) throw error

    // Cache the results
    cacheSeatAssignments(assignments)
    
    return assignments || []
  } catch (error) {
    console.error('Error fetching seat assignments:', error)
    return []
  }
}
```

### Caching Strategy
```typescript
// Add to dataService.ts
const SEAT_ASSIGNMENTS_CACHE_KEY = 'kn_seat_assignments'
const CACHE_DURATION = 5 * 60 * 1000 // 5 minutes

interface CachedSeatAssignments {
  assignments: SeatAssignment[]
  timestamp: number
}

const cacheSeatAssignments = (assignments: SeatAssignment[]): void => {
  const cacheData: CachedSeatAssignments = {
    assignments,
    timestamp: Date.now()
  }
  localStorage.setItem(SEAT_ASSIGNMENTS_CACHE_KEY, JSON.stringify(cacheData))
}

const getCachedSeatAssignments = (): CachedSeatAssignments | null => {
  const cached = localStorage.getItem(SEAT_ASSIGNMENTS_CACHE_KEY)
  return cached ? JSON.parse(cached) : null
}

const isExpired = (cache: CachedSeatAssignments): boolean => {
  return Date.now() - cache.timestamp > CACHE_DURATION
}
```

### Success Criteria
- [ ] `getAttendeeSeatAssignments()` returns both agenda and dining assignments
- [ ] localStorage caching implemented with 5-minute expiration
- [ ] Backward compatibility maintained (existing features still work)
- [ ] Unit tests cover all scenarios (80% line coverage)

---

## 🎣 Phase 3: Hook Enhancement

### Objectives
- Remove dining event exclusion from `enhanceEventWithSeatInfo()`
- Add dining-specific seat matching logic
- Maintain agenda item seat assignment functionality

### Current Implementation (BROKEN)
```javascript
// src/hooks/useSessionData.js (lines 536-539)
const enhanceEventWithSeatInfo = (event) => {
  if (!event || !seatAssignments.length) return event || null;
  
  // THIS IS THE PROBLEM - dining events are excluded
  if (event.type === 'dining') {
    return event;
  }
  
  // Agenda item logic...
}
```

### New Implementation
```javascript
// src/hooks/useSessionData.js (updated)
const enhanceEventWithSeatInfo = (event) => {
  if (!event || !seatAssignments.length) return event || null;
  
  // Find seat assignment for this event (works for BOTH agenda and dining)
  const seatAssignment = findSeatAssignmentForEvent(event)
  
  return {
    ...event,
    seatInfo: seatAssignment ? {
      table: seatAssignment.table_name,
      seat: seatAssignment.seat_number,
      position: seatAssignment.seat_position,
      seatingConfigurationId: seatAssignment.seating_configuration_id
    } : null
  }
}

// Helper function to find seat assignment
const findSeatAssignmentForEvent = (event) => {
  if (!event || !seatAssignments.length) return null
  
  return seatAssignments.find(seat => {
    // Match based on event type
    if (event.type === 'dining') {
      // Dining events: match via dining_option_id in seating_configuration
      return seat.seating_configurations?.dining_option_id === event.id
    } else {
      // Agenda items: match via seating_configuration_id or agenda_item_id
      return seat.seating_configuration_id === event.seating_configuration_id ||
             seat.seating_configurations?.agenda_item_id === event.id
    }
  })
}
```

### Key Changes
1. **Remove exclusion**: Delete the `if (event.type === 'dining') return event` check
2. **Unified matching**: Single function handles both event types
3. **Flexible joins**: Works with both direct and nested seating_configurations data

### Testing Strategy
```javascript
// src/__tests__/hooks/useSessionData-dining-seats.test.js
describe('useSessionData - Dining Seat Enhancement', () => {
  it('should enhance dining event with seat assignment', () => {
    const diningEvent = {
      id: 'dining-1',
      type: 'dining',
      seating_type: 'assigned'
    }
    
    const seatAssignment = {
      seating_configuration_id: 'config-1',
      seating_configurations: {
        dining_option_id: 'dining-1'
      },
      table_name: 'Table 5',
      seat_number: 12
    }
    
    // Test that enhancement works correctly
  })
})
```

### Success Criteria
- [ ] Dining events receive seat info when assignments exist
- [ ] Agenda items continue to work correctly
- [ ] `seatInfo` object structure is consistent across both types
- [ ] Unit tests achieve 80% line coverage

---

## 🎨 Phase 4: Display Enhancement

### Objectives
- Verify SessionCard displays dining seat assignments correctly
- Add "pending assignment" message for assigned seating without assignment
- Ensure visual consistency with agenda item seat display

### Current Implementation
```javascript
// src/components/session/SessionCard.jsx (lines 397-443)
// Seat assignment display ALREADY EXISTS
{seatInfo && (
  <div className="seat-assignment" onClick={handleSeatMapClick}>
    <div className="seat-label">Your Seat</div>
    <div className="seat-details">
      <span>{seatInfo.table} • Seat {seatInfo.seat}</span>
      <span className="seat-map-link">Find my seat</span>
    </div>
  </div>
)}

// Open seating display (ALREADY WORKS for dining)
{session.seating_type === 'open' && (
  <div className="seating-indicator open-seating">
    <Icon name="users" size={14} className="seating-icon" />
    <span>Open seating</span>
  </div>
)}
```

### Required Addition
```javascript
// Add: Assigned seating with NO assignment
{isDiningEventSession && 
 session.seating_type === 'assigned' && 
 !seatInfo && (
  <div className="seat-assignment pending">
    <div className="seat-label">Seat Assignment</div>
    <div className="seat-details pending-text">
      <span>Assignment pending</span>
    </div>
  </div>
)}
```

### CSS Updates (if needed)
```css
/* src/components/session/SessionCard.css */
.seat-assignment.pending {
  cursor: default;
  opacity: 0.8;
}

.seat-assignment .pending-text {
  color: var(--text-secondary);
  font-style: italic;
}
```

### Testing Strategy
```javascript
// src/__tests__/components/SessionCard-dining-seats.test.jsx
describe('SessionCard - Dining Seat Display', () => {
  it('should display dining seat assignment', () => {
    const session = {
      type: 'dining',
      seating_type: 'assigned',
      seatInfo: {
        table: 'Table 5',
        seat: 12
      }
    }
    
    render(<SessionCard session={session} />)
    expect(screen.getByText('Table 5 • Seat 12')).toBeInTheDocument()
  })
  
  it('should display pending message when no assignment', () => {
    const session = {
      type: 'dining',
      seating_type: 'assigned',
      seatInfo: null
    }
    
    render(<SessionCard session={session} />)
    expect(screen.getByText('Assignment pending')).toBeInTheDocument()
  })
})
```

### Success Criteria
- [ ] Dining seat assignments display correctly
- [ ] Pending message shows for unassigned seats
- [ ] Visual styling matches agenda seat assignments
- [ ] Component tests achieve 80% coverage

---

## 🧭 Phase 5: Navigation Implementation

### Objectives
- Enable seat map navigation for dining events
- Pass correct venue/location data for dining events
- Reuse existing seat map navigation logic

### Current Navigation Logic
```javascript
// src/components/session/SessionCard.jsx (existing for agenda items)
const handleSeatMapClick = (e) => {
  e.stopPropagation()
  
  if (session.location) {
    navigate('/seat-map', {
      state: {
        location: session.location,
        table: seatInfo?.table,
        seatingConfigurationId: session.seating_configuration_id
      }
    })
  }
}
```

### Updated Navigation (works for both types)
```javascript
const handleSeatMapClick = (e) => {
  e.stopPropagation()
  
  if (!seatInfo) return // No navigation if no assignment
  
  // Determine location based on event type
  const location = session.type === 'dining' 
    ? session.location || session.venue // Dining events might use 'venue' field
    : session.location
  
  if (location) {
    navigate('/seat-map', {
      state: {
        location,
        table: seatInfo.table,
        seatingConfigurationId: seatInfo.seatingConfigurationId,
        eventType: session.type, // Add type for context
        eventId: session.id
      }
    })
  }
}
```

### Key Considerations
1. **Location field**: Verify dining events have `location` or `venue` field
2. **Seating config**: Pass `seatingConfigurationId` from seatInfo
3. **Event type**: Help seat map page identify context
4. **No assignment**: Disable click when `seatInfo` is null

### Testing Strategy
```javascript
// src/__tests__/components/SessionCard-navigation.test.jsx
describe('SessionCard - Seat Map Navigation', () => {
  it('should navigate to seat map when dining seat is clicked', () => {
    const mockNavigate = vi.fn()
    vi.mock('react-router-dom', () => ({ useNavigate: () => mockNavigate }))
    
    const session = {
      type: 'dining',
      location: 'Grand Ballroom',
      seatInfo: { table: 'Table 5', seat: 12 }
    }
    
    render(<SessionCard session={session} />)
    fireEvent.click(screen.getByText('Find my seat'))
    
    expect(mockNavigate).toHaveBeenCalledWith('/seat-map', {
      state: expect.objectContaining({
        location: 'Grand Ballroom',
        table: 'Table 5'
      })
    })
  })
})
```

### Success Criteria
- [ ] Clicking dining seat assignment navigates to seat map
- [ ] Correct location/venue data is passed
- [ ] Pending assignments do not navigate
- [ ] Navigation tests pass with good coverage

---

## 🧪 Phase 6: Integration Testing

### Objectives
- Comprehensive end-to-end testing of the feature
- Validate all acceptance criteria
- Test cross-page consistency (Home & Schedule)

### Test Coverage Requirements
- **Unit Tests**: 80% line coverage
- **Integration Tests**: 70% branch coverage
- **Overall**: All acceptance criteria validated

### Integration Test Suite
```javascript
// src/__tests__/integration/dining-seat-assignment.test.tsx
describe('Dining Seat Assignment Integration', () => {
  describe('Data Flow', () => {
    it('should load dining seat assignments from API', async () => {
      // Test: API → dataService → localStorage
    })
    
    it('should use cached data when available', async () => {
      // Test: localStorage → hook → component
    })
  })
  
  describe('Display Consistency', () => {
    it('should display same seat info on Home page', async () => {
      // Test: Home page now/next cards
    })
    
    it('should display same seat info on Schedule page', async () => {
      // Test: Schedule page session cards
    })
  })
  
  describe('Acceptance Criteria Validation', () => {
    it('AC-1: displays assigned seat correctly', async () => {})
    it('AC-2: displays open seating correctly', async () => {})
    it('AC-3: displays pending message correctly', async () => {})
    it('AC-4: consistent across pages', async () => {})
    it('AC-5: navigates to seat map', async () => {})
    it('AC-6: visual consistency', async () => {})
    it('AC-7: data integration working', async () => {})
  })
})
```

### Manual Testing Checklist
- [ ] Test with dining event that has seat assignment
- [ ] Test with dining event that has NO assignment (assigned seating)
- [ ] Test with dining event that has open seating
- [ ] Test seat map navigation from Home page
- [ ] Test seat map navigation from Schedule page
- [ ] Verify localStorage caching is working
- [ ] Test with multiple dining events
- [ ] Test with no dining events

### Success Criteria
- [ ] All unit tests pass with 80%+ line coverage
- [ ] All integration tests pass with 70%+ branch coverage
- [ ] All 9 acceptance criteria validated
- [ ] Manual testing checklist complete

---

## 📚 Phase 7: Documentation & Completion

### Objectives
- Update story with implementation details
- Create completion report
- Document any learnings or issues

### Story Updates
```markdown
## Dev Agent Record
**Implementation Date**: 2025-10-11  
**Developer**: BMad Orchestrator + Dev Agent  
**Status**: Complete ✅

### Implementation Summary
Successfully completed the dining seat assignment display feature by:
1. Updated `dataService.ts` to fetch dining seat assignments
2. Removed dining event exclusion in `useSessionData.js`
3. Added dining-specific seat matching logic
4. Verified SessionCard display logic works for dining events
5. Added "pending assignment" message for unassigned seats
6. Implemented seat map navigation for dining events
7. Achieved comprehensive test coverage (80%+ unit, 70%+ integration)

### Key Files Modified
- `src/services/dataService.ts` - Enhanced seat assignment fetching
- `src/hooks/useSessionData.js` - Removed dining exclusion, added matching
- `src/components/session/SessionCard.jsx` - Added pending message display
- `src/__tests__/**` - Comprehensive test suite

### Test Coverage
- Unit Tests: 85% line coverage
- Integration Tests: 72% branch coverage
- All acceptance criteria validated ✅

### Known Issues / Limitations
- None

### Future Enhancements
- Consider real-time seat assignment updates
- Add seat assignment change notifications
```

### Completion Report
Create: `docs/completion-reports/2.1g.3.1-dining-seat-assignment-completion.md`

### Success Criteria
- [ ] Dev Agent Record updated in story file
- [ ] Completion report created
- [ ] Story status updated to "Complete"
- [ ] Test coverage documented

---

## 📊 Risk Assessment

### Technical Risks
| Risk | Impact | Mitigation |
|------|--------|------------|
| Database schema different than expected | High | Phase 1 investigation validates structure first |
| Existing tests fail after changes | Medium | Run full test suite before/after changes |
| Performance impact from additional queries | Low | Caching strategy minimizes API calls |
| Seat map page doesn't support dining events | Medium | Test navigation early, add support if needed |

### Schedule Risks
| Risk | Impact | Mitigation |
|------|--------|------------|
| Data structure investigation takes longer | Low | Allow extra time in Phase 1 |
| Test coverage goals difficult to achieve | Medium | Focus on critical paths first |
| Integration testing reveals issues | Medium | Buffer time in Phase 6 |

---

## 🎯 Definition of Done

### Feature Complete When:
- ✅ All 7 phases completed
- ✅ All 9 acceptance criteria validated
- ✅ Unit test coverage ≥ 80%
- ✅ Integration test coverage ≥ 70%
- ✅ Manual testing checklist complete
- ✅ No linter errors or warnings
- ✅ Code reviewed and approved
- ✅ Documentation updated
- ✅ Story status updated to "Complete"

### Code Quality Standards:
- Follows project coding standards (docs/architecture/coding-standards.md)
- Type-safe (TypeScript where applicable)
- Properly commented
- No console errors in browser
- Responsive design maintained
- Accessibility standards met

---

## 🚀 Estimated Timeline

| Phase | Duration | Dependencies |
|-------|----------|--------------|
| Phase 1: Investigation | 1-2 hours | Database access |
| Phase 2: Data Service | 2-3 hours | Phase 1 complete |
| Phase 3: Hook Enhancement | 2-3 hours | Phase 2 complete |
| Phase 4: Display | 1-2 hours | Phase 3 complete |
| Phase 5: Navigation | 1-2 hours | Phase 4 complete |
| Phase 6: Testing | 3-4 hours | Phases 2-5 complete |
| Phase 7: Documentation | 1 hour | All phases complete |
| **Total** | **11-17 hours** | Sequential execution |

---

## 📝 Notes for Implementation

### Development Best Practices
1. **Test First**: Write tests before implementing features (TDD approach)
2. **Incremental Changes**: Commit after each phase completion
3. **Run Tests Frequently**: Catch regressions early
4. **Document As You Go**: Update comments and docs during implementation

### Debugging Tips
- Use browser DevTools to inspect localStorage caching
- Console.log seat assignment matching in useSessionData
- Verify database queries return expected data in Phase 1
- Test with real event data (not just mocks)

### Common Pitfalls to Avoid
- Don't assume dining events have same fields as agenda items
- Don't skip localStorage caching (performance critical)
- Don't forget to handle edge cases (no assignment, open seating)
- Don't neglect visual consistency testing

---

## 📞 Support & Questions

### Key Resources
- **Story File**: `docs/stories/2.1g.3.1-dining-seat-assignment-display.md`
- **Architecture**: `docs/architecture/tech-stack.md`
- **Testing Standards**: `docs/architecture/coding-standards.md`
- **Database Schema**: `docs/architecture/database-schema.md`

### BMad Agents Available
- `*agent dev` - Development implementation
- `*agent qa` - Quality assurance and testing
- `*agent architect` - Architecture decisions
- `*agent po` - Requirements clarification

---

*This implementation plan is a living document and will be updated as implementation progresses.*

